7eefbb9bc5ef4ec22cba8ed4db0f6b9d
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _EventEmitter = _interopRequireDefault(require("../vendor/emitter/EventEmitter"));

var BatchedBridge = require('../BatchedBridge/BatchedBridge');

var TaskQueue = require('./TaskQueue');

var infoLog = require('../Utilities/infoLog');

var invariant = require('invariant');

var _emitter = new _EventEmitter.default();

var DEBUG_DELAY = 0;
var DEBUG = false;
var InteractionManager = {
  Events: {
    interactionStart: 'interactionStart',
    interactionComplete: 'interactionComplete'
  },
  runAfterInteractions: function runAfterInteractions(task) {
    var tasks = [];
    var promise = new Promise(function (resolve) {
      _scheduleUpdate();

      if (task) {
        tasks.push(task);
      }

      tasks.push({
        run: resolve,
        name: 'resolve ' + (task && task.name || '?')
      });

      _taskQueue.enqueueTasks(tasks);
    });
    return {
      then: promise.then.bind(promise),
      done: function done() {
        if (promise.done) {
          return promise.done.apply(promise, arguments);
        } else {
          console.warn('Tried to call done when not supported by current Promise implementation.');
        }
      },
      cancel: function cancel() {
        _taskQueue.cancelTasks(tasks);
      }
    };
  },
  createInteractionHandle: function createInteractionHandle() {
    DEBUG && infoLog('InteractionManager: create interaction handle');

    _scheduleUpdate();

    var handle = ++_inc;

    _addInteractionSet.add(handle);

    return handle;
  },
  clearInteractionHandle: function clearInteractionHandle(handle) {
    DEBUG && infoLog('InteractionManager: clear interaction handle');
    invariant(!!handle, 'InteractionManager: Must provide a handle to clear.');

    _scheduleUpdate();

    _addInteractionSet.delete(handle);

    _deleteInteractionSet.add(handle);
  },
  addListener: _emitter.addListener.bind(_emitter),
  setDeadline: function setDeadline(deadline) {
    _deadline = deadline;
  }
};

var _interactionSet = new Set();

var _addInteractionSet = new Set();

var _deleteInteractionSet = new Set();

var _taskQueue = new TaskQueue({
  onMoreTasks: _scheduleUpdate
});

var _nextUpdateHandle = 0;
var _inc = 0;

var _deadline = -1;

function _scheduleUpdate() {
  if (!_nextUpdateHandle) {
    if (_deadline > 0) {
      _nextUpdateHandle = setTimeout(_processUpdate, 0 + DEBUG_DELAY);
    } else {
      _nextUpdateHandle = setImmediate(_processUpdate);
    }
  }
}

function _processUpdate() {
  _nextUpdateHandle = 0;
  var interactionCount = _interactionSet.size;

  _addInteractionSet.forEach(function (handle) {
    return _interactionSet.add(handle);
  });

  _deleteInteractionSet.forEach(function (handle) {
    return _interactionSet.delete(handle);
  });

  var nextInteractionCount = _interactionSet.size;

  if (interactionCount !== 0 && nextInteractionCount === 0) {
    _emitter.emit(InteractionManager.Events.interactionComplete);
  } else if (interactionCount === 0 && nextInteractionCount !== 0) {
    _emitter.emit(InteractionManager.Events.interactionStart);
  }

  if (nextInteractionCount === 0) {
    while (_taskQueue.hasTasksToProcess()) {
      _taskQueue.processNext();

      if (_deadline > 0 && BatchedBridge.getEventLoopRunningTime() >= _deadline) {
        _scheduleUpdate();

        break;
      }
    }
  }

  _addInteractionSet.clear();

  _deleteInteractionSet.clear();
}

module.exports = InteractionManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCYXRjaGVkQnJpZGdlIiwicmVxdWlyZSIsIlRhc2tRdWV1ZSIsImluZm9Mb2ciLCJpbnZhcmlhbnQiLCJfZW1pdHRlciIsIkV2ZW50RW1pdHRlciIsIkRFQlVHX0RFTEFZIiwiREVCVUciLCJJbnRlcmFjdGlvbk1hbmFnZXIiLCJFdmVudHMiLCJpbnRlcmFjdGlvblN0YXJ0IiwiaW50ZXJhY3Rpb25Db21wbGV0ZSIsInJ1bkFmdGVySW50ZXJhY3Rpb25zIiwidGFzayIsInRhc2tzIiwicHJvbWlzZSIsIlByb21pc2UiLCJyZXNvbHZlIiwiX3NjaGVkdWxlVXBkYXRlIiwicHVzaCIsInJ1biIsIm5hbWUiLCJfdGFza1F1ZXVlIiwiZW5xdWV1ZVRhc2tzIiwidGhlbiIsImJpbmQiLCJkb25lIiwiY29uc29sZSIsIndhcm4iLCJjYW5jZWwiLCJjYW5jZWxUYXNrcyIsImNyZWF0ZUludGVyYWN0aW9uSGFuZGxlIiwiaGFuZGxlIiwiX2luYyIsIl9hZGRJbnRlcmFjdGlvblNldCIsImFkZCIsImNsZWFySW50ZXJhY3Rpb25IYW5kbGUiLCJkZWxldGUiLCJfZGVsZXRlSW50ZXJhY3Rpb25TZXQiLCJhZGRMaXN0ZW5lciIsInNldERlYWRsaW5lIiwiZGVhZGxpbmUiLCJfZGVhZGxpbmUiLCJfaW50ZXJhY3Rpb25TZXQiLCJTZXQiLCJvbk1vcmVUYXNrcyIsIl9uZXh0VXBkYXRlSGFuZGxlIiwic2V0VGltZW91dCIsIl9wcm9jZXNzVXBkYXRlIiwic2V0SW1tZWRpYXRlIiwiaW50ZXJhY3Rpb25Db3VudCIsInNpemUiLCJmb3JFYWNoIiwibmV4dEludGVyYWN0aW9uQ291bnQiLCJlbWl0IiwiaGFzVGFza3NUb1Byb2Nlc3MiLCJwcm9jZXNzTmV4dCIsImdldEV2ZW50TG9vcFJ1bm5pbmdUaW1lIiwiY2xlYXIiLCJtb2R1bGUiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiSW50ZXJhY3Rpb25NYW5hZ2VyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBNZXRhIFBsYXRmb3JtcywgSW5jLiBhbmQgYWZmaWxpYXRlcy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZm9ybWF0XG4gKiBAZmxvdyBzdHJpY3QtbG9jYWxcbiAqL1xuXG5jb25zdCBCYXRjaGVkQnJpZGdlID0gcmVxdWlyZSgnLi4vQmF0Y2hlZEJyaWRnZS9CYXRjaGVkQnJpZGdlJyk7XG5jb25zdCBUYXNrUXVldWUgPSByZXF1aXJlKCcuL1Rhc2tRdWV1ZScpO1xuXG5jb25zdCBpbmZvTG9nID0gcmVxdWlyZSgnLi4vVXRpbGl0aWVzL2luZm9Mb2cnKTtcbmNvbnN0IGludmFyaWFudCA9IHJlcXVpcmUoJ2ludmFyaWFudCcpO1xuXG5pbXBvcnQgRXZlbnRFbWl0dGVyIGZyb20gJy4uL3ZlbmRvci9lbWl0dGVyL0V2ZW50RW1pdHRlcic7XG5cbmV4cG9ydCB0eXBlIEhhbmRsZSA9IG51bWJlcjtcbmltcG9ydCB0eXBlIHtUYXNrfSBmcm9tICcuL1Rhc2tRdWV1ZSc7XG5cbmNvbnN0IF9lbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcjx7XG4gIGludGVyYWN0aW9uQ29tcGxldGU6IFtdLFxuICBpbnRlcmFjdGlvblN0YXJ0OiBbXSxcbn0+KCk7XG5cbmNvbnN0IERFQlVHX0RFTEFZOiAwID0gMDtcbmNvbnN0IERFQlVHOiBmYWxzZSA9IGZhbHNlO1xuXG4vKipcbiAqIEludGVyYWN0aW9uTWFuYWdlciBhbGxvd3MgbG9uZy1ydW5uaW5nIHdvcmsgdG8gYmUgc2NoZWR1bGVkIGFmdGVyIGFueVxuICogaW50ZXJhY3Rpb25zL2FuaW1hdGlvbnMgaGF2ZSBjb21wbGV0ZWQuIEluIHBhcnRpY3VsYXIsIHRoaXMgYWxsb3dzIEphdmFTY3JpcHRcbiAqIGFuaW1hdGlvbnMgdG8gcnVuIHNtb290aGx5LlxuICpcbiAqIEFwcGxpY2F0aW9ucyBjYW4gc2NoZWR1bGUgdGFza3MgdG8gcnVuIGFmdGVyIGludGVyYWN0aW9ucyB3aXRoIHRoZSBmb2xsb3dpbmc6XG4gKlxuICogYGBgXG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIucnVuQWZ0ZXJJbnRlcmFjdGlvbnMoKCkgPT4ge1xuICogICAvLyAuLi5sb25nLXJ1bm5pbmcgc3luY2hyb25vdXMgdGFzay4uLlxuICogfSk7XG4gKiBgYGBcbiAqXG4gKiBDb21wYXJlIHRoaXMgdG8gb3RoZXIgc2NoZWR1bGluZyBhbHRlcm5hdGl2ZXM6XG4gKlxuICogLSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKTogZm9yIGNvZGUgdGhhdCBhbmltYXRlcyBhIHZpZXcgb3ZlciB0aW1lLlxuICogLSBzZXRJbW1lZGlhdGUvc2V0VGltZW91dCgpOiBydW4gY29kZSBsYXRlciwgbm90ZSB0aGlzIG1heSBkZWxheSBhbmltYXRpb25zLlxuICogLSBydW5BZnRlckludGVyYWN0aW9ucygpOiBydW4gY29kZSBsYXRlciwgd2l0aG91dCBkZWxheWluZyBhY3RpdmUgYW5pbWF0aW9ucy5cbiAqXG4gKiBUaGUgdG91Y2ggaGFuZGxpbmcgc3lzdGVtIGNvbnNpZGVycyBvbmUgb3IgbW9yZSBhY3RpdmUgdG91Y2hlcyB0byBiZSBhblxuICogJ2ludGVyYWN0aW9uJyBhbmQgd2lsbCBkZWxheSBgcnVuQWZ0ZXJJbnRlcmFjdGlvbnMoKWAgY2FsbGJhY2tzIHVudGlsIGFsbFxuICogdG91Y2hlcyBoYXZlIGVuZGVkIG9yIGJlZW4gY2FuY2VsbGVkLlxuICpcbiAqIEludGVyYWN0aW9uTWFuYWdlciBhbHNvIGFsbG93cyBhcHBsaWNhdGlvbnMgdG8gcmVnaXN0ZXIgYW5pbWF0aW9ucyBieVxuICogY3JlYXRpbmcgYW4gaW50ZXJhY3Rpb24gJ2hhbmRsZScgb24gYW5pbWF0aW9uIHN0YXJ0LCBhbmQgY2xlYXJpbmcgaXQgdXBvblxuICogY29tcGxldGlvbjpcbiAqXG4gKiBgYGBcbiAqIHZhciBoYW5kbGUgPSBJbnRlcmFjdGlvbk1hbmFnZXIuY3JlYXRlSW50ZXJhY3Rpb25IYW5kbGUoKTtcbiAqIC8vIHJ1biBhbmltYXRpb24uLi4gKGBydW5BZnRlckludGVyYWN0aW9uc2AgdGFza3MgYXJlIHF1ZXVlZClcbiAqIC8vIGxhdGVyLCBvbiBhbmltYXRpb24gY29tcGxldGlvbjpcbiAqIEludGVyYWN0aW9uTWFuYWdlci5jbGVhckludGVyYWN0aW9uSGFuZGxlKGhhbmRsZSk7XG4gKiAvLyBxdWV1ZWQgdGFza3MgcnVuIGlmIGFsbCBoYW5kbGVzIHdlcmUgY2xlYXJlZFxuICogYGBgXG4gKlxuICogYHJ1bkFmdGVySW50ZXJhY3Rpb25zYCB0YWtlcyBlaXRoZXIgYSBwbGFpbiBjYWxsYmFjayBmdW5jdGlvbiwgb3IgYVxuICogYFByb21pc2VUYXNrYCBvYmplY3Qgd2l0aCBhIGBnZW5gIG1ldGhvZCB0aGF0IHJldHVybnMgYSBgUHJvbWlzZWAuICBJZiBhXG4gKiBgUHJvbWlzZVRhc2tgIGlzIHN1cHBsaWVkLCB0aGVuIGl0IGlzIGZ1bGx5IHJlc29sdmVkIChpbmNsdWRpbmcgYXN5bmNocm9ub3VzXG4gKiBkZXBlbmRlbmNpZXMgdGhhdCBhbHNvIHNjaGVkdWxlIG1vcmUgdGFza3MgdmlhIGBydW5BZnRlckludGVyYWN0aW9uc2ApIGJlZm9yZVxuICogc3RhcnRpbmcgb24gdGhlIG5leHQgdGFzayB0aGF0IG1pZ2h0IGhhdmUgYmVlbiBxdWV1ZWQgdXAgc3luY2hyb25vdXNseVxuICogZWFybGllci5cbiAqXG4gKiBCeSBkZWZhdWx0LCBxdWV1ZWQgdGFza3MgYXJlIGV4ZWN1dGVkIHRvZ2V0aGVyIGluIGEgbG9vcCBpbiBvbmVcbiAqIGBzZXRJbW1lZGlhdGVgIGJhdGNoLiBJZiBgc2V0RGVhZGxpbmVgIGlzIGNhbGxlZCB3aXRoIGEgcG9zaXRpdmUgbnVtYmVyLCB0aGVuXG4gKiB0YXNrcyB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgdW50aWwgdGhlIGRlYWRsaW5lIChpbiB0ZXJtcyBvZiBqcyBldmVudCBsb29wIHJ1blxuICogdGltZSkgYXBwcm9hY2hlcywgYXQgd2hpY2ggcG9pbnQgZXhlY3V0aW9uIHdpbGwgeWllbGQgdmlhIHNldFRpbWVvdXQsXG4gKiBhbGxvd2luZyBldmVudHMgc3VjaCBhcyB0b3VjaGVzIHRvIHN0YXJ0IGludGVyYWN0aW9ucyBhbmQgYmxvY2sgcXVldWVkIHRhc2tzXG4gKiBmcm9tIGV4ZWN1dGluZywgbWFraW5nIGFwcHMgbW9yZSByZXNwb25zaXZlLlxuICovXG5jb25zdCBJbnRlcmFjdGlvbk1hbmFnZXIgPSB7XG4gIEV2ZW50czoge1xuICAgIGludGVyYWN0aW9uU3RhcnQ6ICdpbnRlcmFjdGlvblN0YXJ0JyxcbiAgICBpbnRlcmFjdGlvbkNvbXBsZXRlOiAnaW50ZXJhY3Rpb25Db21wbGV0ZScsXG4gIH0sXG5cbiAgLyoqXG4gICAqIFNjaGVkdWxlIGEgZnVuY3Rpb24gdG8gcnVuIGFmdGVyIGFsbCBpbnRlcmFjdGlvbnMgaGF2ZSBjb21wbGV0ZWQuIFJldHVybnMgYSBjYW5jZWxsYWJsZVxuICAgKiBcInByb21pc2VcIi5cbiAgICovXG4gIHJ1bkFmdGVySW50ZXJhY3Rpb25zKHRhc2s6ID9UYXNrKToge1xuICAgIHRoZW46IDxVPihcbiAgICAgIG9uRnVsZmlsbD86ID8odm9pZCkgPT4gPyhQcm9taXNlPFU+IHwgVSksXG4gICAgICBvblJlamVjdD86ID8oZXJyb3I6IG1peGVkKSA9PiA/KFByb21pc2U8VT4gfCBVKSxcbiAgICApID0+IFByb21pc2U8VT4sXG4gICAgZG9uZTogKCkgPT4gdm9pZCxcbiAgICBjYW5jZWw6ICgpID0+IHZvaWQsXG4gICAgLi4uXG4gIH0ge1xuICAgIGNvbnN0IHRhc2tzOiBBcnJheTxUYXNrPiA9IFtdO1xuICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZTogKCkgPT4gdm9pZCkgPT4ge1xuICAgICAgX3NjaGVkdWxlVXBkYXRlKCk7XG4gICAgICBpZiAodGFzaykge1xuICAgICAgICB0YXNrcy5wdXNoKHRhc2spO1xuICAgICAgfVxuICAgICAgdGFza3MucHVzaCh7XG4gICAgICAgIHJ1bjogcmVzb2x2ZSxcbiAgICAgICAgbmFtZTogJ3Jlc29sdmUgJyArICgodGFzayAmJiB0YXNrLm5hbWUpIHx8ICc/JyksXG4gICAgICB9KTtcbiAgICAgIF90YXNrUXVldWUuZW5xdWV1ZVRhc2tzKHRhc2tzKTtcbiAgICB9KTtcbiAgICByZXR1cm4ge1xuICAgICAgLy8gJEZsb3dGaXhNZVttZXRob2QtdW5iaW5kaW5nXSBhZGRlZCB3aGVuIGltcHJvdmluZyB0eXBpbmcgZm9yIHRoaXMgcGFyYW1ldGVyc1xuICAgICAgdGhlbjogcHJvbWlzZS50aGVuLmJpbmQocHJvbWlzZSksXG4gICAgICBkb25lOiAoLi4uYXJncykgPT4ge1xuICAgICAgICAvLyAkRmxvd0ZpeE1lW21ldGhvZC11bmJpbmRpbmddIGFkZGVkIHdoZW4gaW1wcm92aW5nIHR5cGluZyBmb3IgdGhpcyBwYXJhbWV0ZXJzXG4gICAgICAgIGlmIChwcm9taXNlLmRvbmUpIHtcbiAgICAgICAgICByZXR1cm4gcHJvbWlzZS5kb25lKC4uLmFyZ3MpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICAgICdUcmllZCB0byBjYWxsIGRvbmUgd2hlbiBub3Qgc3VwcG9ydGVkIGJ5IGN1cnJlbnQgUHJvbWlzZSBpbXBsZW1lbnRhdGlvbi4nLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBjYW5jZWw6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgX3Rhc2tRdWV1ZS5jYW5jZWxUYXNrcyh0YXNrcyk7XG4gICAgICB9LFxuICAgIH07XG4gIH0sXG5cbiAgLyoqXG4gICAqIE5vdGlmeSBtYW5hZ2VyIHRoYXQgYW4gaW50ZXJhY3Rpb24gaGFzIHN0YXJ0ZWQuXG4gICAqL1xuICBjcmVhdGVJbnRlcmFjdGlvbkhhbmRsZSgpOiBIYW5kbGUge1xuICAgIERFQlVHICYmIGluZm9Mb2coJ0ludGVyYWN0aW9uTWFuYWdlcjogY3JlYXRlIGludGVyYWN0aW9uIGhhbmRsZScpO1xuICAgIF9zY2hlZHVsZVVwZGF0ZSgpO1xuICAgIGNvbnN0IGhhbmRsZSA9ICsrX2luYztcbiAgICBfYWRkSW50ZXJhY3Rpb25TZXQuYWRkKGhhbmRsZSk7XG4gICAgcmV0dXJuIGhhbmRsZTtcbiAgfSxcblxuICAvKipcbiAgICogTm90aWZ5IG1hbmFnZXIgdGhhdCBhbiBpbnRlcmFjdGlvbiBoYXMgY29tcGxldGVkLlxuICAgKi9cbiAgY2xlYXJJbnRlcmFjdGlvbkhhbmRsZShoYW5kbGU6IEhhbmRsZSkge1xuICAgIERFQlVHICYmIGluZm9Mb2coJ0ludGVyYWN0aW9uTWFuYWdlcjogY2xlYXIgaW50ZXJhY3Rpb24gaGFuZGxlJyk7XG4gICAgaW52YXJpYW50KCEhaGFuZGxlLCAnSW50ZXJhY3Rpb25NYW5hZ2VyOiBNdXN0IHByb3ZpZGUgYSBoYW5kbGUgdG8gY2xlYXIuJyk7XG4gICAgX3NjaGVkdWxlVXBkYXRlKCk7XG4gICAgX2FkZEludGVyYWN0aW9uU2V0LmRlbGV0ZShoYW5kbGUpO1xuICAgIF9kZWxldGVJbnRlcmFjdGlvblNldC5hZGQoaGFuZGxlKTtcbiAgfSxcblxuICAvLyAkRmxvd0ZpeE1lW21ldGhvZC11bmJpbmRpbmddIGFkZGVkIHdoZW4gaW1wcm92aW5nIHR5cGluZyBmb3IgdGhpcyBwYXJhbWV0ZXJzXG4gIGFkZExpc3RlbmVyOiAoX2VtaXR0ZXIuYWRkTGlzdGVuZXIuYmluZChfZW1pdHRlcik6ICRGbG93Rml4TWUpLFxuXG4gIC8qKlxuICAgKiBBIHBvc2l0aXZlIG51bWJlciB3aWxsIHVzZSBzZXRUaW1lb3V0IHRvIHNjaGVkdWxlIGFueSB0YXNrcyBhZnRlciB0aGVcbiAgICogZXZlbnRMb29wUnVubmluZ1RpbWUgaGl0cyB0aGUgZGVhZGxpbmUgdmFsdWUsIG90aGVyd2lzZSBhbGwgdGFza3Mgd2lsbCBiZVxuICAgKiBleGVjdXRlZCBpbiBvbmUgc2V0SW1tZWRpYXRlIGJhdGNoIChkZWZhdWx0KS5cbiAgICovXG4gIHNldERlYWRsaW5lKGRlYWRsaW5lOiBudW1iZXIpIHtcbiAgICBfZGVhZGxpbmUgPSBkZWFkbGluZTtcbiAgfSxcbn07XG5cbmNvbnN0IF9pbnRlcmFjdGlvblNldCA9IG5ldyBTZXQoKTtcbmNvbnN0IF9hZGRJbnRlcmFjdGlvblNldCA9IG5ldyBTZXQoKTtcbmNvbnN0IF9kZWxldGVJbnRlcmFjdGlvblNldCA9IG5ldyBTZXQoKTtcbmNvbnN0IF90YXNrUXVldWUgPSBuZXcgVGFza1F1ZXVlKHtvbk1vcmVUYXNrczogX3NjaGVkdWxlVXBkYXRlfSk7XG5sZXQgX25leHRVcGRhdGVIYW5kbGUgPSAwO1xubGV0IF9pbmMgPSAwO1xubGV0IF9kZWFkbGluZSA9IC0xO1xuXG4vKipcbiAqIFNjaGVkdWxlIGFuIGFzeW5jaHJvbm91cyB1cGRhdGUgdG8gdGhlIGludGVyYWN0aW9uIHN0YXRlLlxuICovXG5mdW5jdGlvbiBfc2NoZWR1bGVVcGRhdGUoKSB7XG4gIGlmICghX25leHRVcGRhdGVIYW5kbGUpIHtcbiAgICBpZiAoX2RlYWRsaW5lID4gMCkge1xuICAgICAgX25leHRVcGRhdGVIYW5kbGUgPSBzZXRUaW1lb3V0KF9wcm9jZXNzVXBkYXRlLCAwICsgREVCVUdfREVMQVkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBfbmV4dFVwZGF0ZUhhbmRsZSA9IHNldEltbWVkaWF0ZShfcHJvY2Vzc1VwZGF0ZSk7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogTm90aWZ5IGxpc3RlbmVycywgcHJvY2VzcyBxdWV1ZSwgZXRjXG4gKi9cbmZ1bmN0aW9uIF9wcm9jZXNzVXBkYXRlKCkge1xuICBfbmV4dFVwZGF0ZUhhbmRsZSA9IDA7XG5cbiAgY29uc3QgaW50ZXJhY3Rpb25Db3VudCA9IF9pbnRlcmFjdGlvblNldC5zaXplO1xuICBfYWRkSW50ZXJhY3Rpb25TZXQuZm9yRWFjaChoYW5kbGUgPT4gX2ludGVyYWN0aW9uU2V0LmFkZChoYW5kbGUpKTtcbiAgX2RlbGV0ZUludGVyYWN0aW9uU2V0LmZvckVhY2goaGFuZGxlID0+IF9pbnRlcmFjdGlvblNldC5kZWxldGUoaGFuZGxlKSk7XG4gIGNvbnN0IG5leHRJbnRlcmFjdGlvbkNvdW50ID0gX2ludGVyYWN0aW9uU2V0LnNpemU7XG5cbiAgaWYgKGludGVyYWN0aW9uQ291bnQgIT09IDAgJiYgbmV4dEludGVyYWN0aW9uQ291bnQgPT09IDApIHtcbiAgICAvLyB0cmFuc2l0aW9uIGZyb20gMSsgLS0+IDAgaW50ZXJhY3Rpb25zXG4gICAgX2VtaXR0ZXIuZW1pdChJbnRlcmFjdGlvbk1hbmFnZXIuRXZlbnRzLmludGVyYWN0aW9uQ29tcGxldGUpO1xuICB9IGVsc2UgaWYgKGludGVyYWN0aW9uQ291bnQgPT09IDAgJiYgbmV4dEludGVyYWN0aW9uQ291bnQgIT09IDApIHtcbiAgICAvLyB0cmFuc2l0aW9uIGZyb20gMCAtLT4gMSsgaW50ZXJhY3Rpb25zXG4gICAgX2VtaXR0ZXIuZW1pdChJbnRlcmFjdGlvbk1hbmFnZXIuRXZlbnRzLmludGVyYWN0aW9uU3RhcnQpO1xuICB9XG5cbiAgLy8gcHJvY2VzcyB0aGUgcXVldWUgcmVnYXJkbGVzcyBvZiBhIHRyYW5zaXRpb25cbiAgaWYgKG5leHRJbnRlcmFjdGlvbkNvdW50ID09PSAwKSB7XG4gICAgd2hpbGUgKF90YXNrUXVldWUuaGFzVGFza3NUb1Byb2Nlc3MoKSkge1xuICAgICAgX3Rhc2tRdWV1ZS5wcm9jZXNzTmV4dCgpO1xuICAgICAgaWYgKFxuICAgICAgICBfZGVhZGxpbmUgPiAwICYmXG4gICAgICAgIEJhdGNoZWRCcmlkZ2UuZ2V0RXZlbnRMb29wUnVubmluZ1RpbWUoKSA+PSBfZGVhZGxpbmVcbiAgICAgICkge1xuICAgICAgICAvLyBIaXQgZGVhZGxpbmUgYmVmb3JlIHByb2Nlc3NpbmcgYWxsIHRhc2tzLCBzbyBwcm9jZXNzIG1vcmUgbGF0ZXIuXG4gICAgICAgIF9zY2hlZHVsZVVwZGF0ZSgpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgX2FkZEludGVyYWN0aW9uU2V0LmNsZWFyKCk7XG4gIF9kZWxldGVJbnRlcmFjdGlvblNldC5jbGVhcigpO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEludGVyYWN0aW9uTWFuYWdlcjtcbiJdLCJtYXBwaW5ncyI6Ijs7QUFnQkE7O0FBTkEsSUFBTUEsYUFBYSxHQUFHQyxPQUFPLENBQUMsZ0NBQUQsQ0FBN0I7O0FBQ0EsSUFBTUMsU0FBUyxHQUFHRCxPQUFPLENBQUMsYUFBRCxDQUF6Qjs7QUFFQSxJQUFNRSxPQUFPLEdBQUdGLE9BQU8sQ0FBQyxzQkFBRCxDQUF2Qjs7QUFDQSxJQUFNRyxTQUFTLEdBQUdILE9BQU8sQ0FBQyxXQUFELENBQXpCOztBQU9BLElBQU1JLFFBQVEsR0FBRyxJQUFJQyxxQkFBSixFQUFqQjs7QUFLQSxJQUFNQyxXQUFjLEdBQUcsQ0FBdkI7QUFDQSxJQUFNQyxLQUFZLEdBQUcsS0FBckI7QUFtREEsSUFBTUMsa0JBQWtCLEdBQUc7RUFDekJDLE1BQU0sRUFBRTtJQUNOQyxnQkFBZ0IsRUFBRSxrQkFEWjtJQUVOQyxtQkFBbUIsRUFBRTtFQUZmLENBRGlCO0VBVXpCQyxvQkFWeUIsZ0NBVUpDLElBVkksRUFrQnZCO0lBQ0EsSUFBTUMsS0FBa0IsR0FBRyxFQUEzQjtJQUNBLElBQU1DLE9BQU8sR0FBRyxJQUFJQyxPQUFKLENBQVksVUFBQ0MsT0FBRCxFQUF5QjtNQUNuREMsZUFBZTs7TUFDZixJQUFJTCxJQUFKLEVBQVU7UUFDUkMsS0FBSyxDQUFDSyxJQUFOLENBQVdOLElBQVg7TUFDRDs7TUFDREMsS0FBSyxDQUFDSyxJQUFOLENBQVc7UUFDVEMsR0FBRyxFQUFFSCxPQURJO1FBRVRJLElBQUksRUFBRSxjQUFlUixJQUFJLElBQUlBLElBQUksQ0FBQ1EsSUFBZCxJQUF1QixHQUFyQztNQUZHLENBQVg7O01BSUFDLFVBQVUsQ0FBQ0MsWUFBWCxDQUF3QlQsS0FBeEI7SUFDRCxDQVZlLENBQWhCO0lBV0EsT0FBTztNQUVMVSxJQUFJLEVBQUVULE9BQU8s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